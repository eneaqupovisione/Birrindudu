<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu & Kitchen Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .title {
            font-size: 2rem;
            font-weight: bold;
            color: #9b59b6;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            color: white;
        }

        .nav-btn.planning { background-color: #9b59b6; }
        .nav-btn.recipes { background-color: #e74c3c; }
        .nav-btn.pantry { background-color: #27ae60; }
        .nav-btn.shopping { background-color: #f39c12; }
        .nav-btn.frigo { background-color: #3498db; }

        .nav-btn:hover {
            transform: translateY(-1px);
            opacity: 0.9;
        }

        .week-navigation {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .week-arrow {
            background-color: #2c3e50;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s ease;
        }

        .week-arrow:hover {
            background-color: #34495e;
        }

        .week-info {
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .section {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .hidden-section {
            display: none;
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }

        /* Menu Planning Table */
        .menu-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
            table-layout: fixed;
        }

        .menu-table th {
            background-color: #34495e;
            color: white;
            padding: 15px 8px;
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
            border: 1px solid #2c3e50;
        }

        .menu-table td {
            border: 1px solid #ddd;
            padding: 8px;
            height: 60px;
            position: relative;
            text-align: center;
            vertical-align: middle;
        }

        .meal-label {
            background-color: #ecf0f1;
            font-weight: 600;
            color: #2c3e50;
            text-align: center;
            font-size: 0.9rem;
            width: 120px;
        }

        .meal-cell {
            background-color: #ffffff;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            font-size: 0.85rem;
            font-weight: 600;
            color: #333;
            min-height: 60px;
            display: table-cell;
            vertical-align: middle;
            border: 2px dashed #e9ecef;
        }

        .meal-cell:hover {
            background-color: #f8f9fa;
            border-color: #9b59b6;
        }

        .meal-cell.empty {
            color: #bdc3c7;
        }

        .meal-cell.filled {
            background-color: #9b59b6;
            color: white;
            border: 2px solid #9b59b6;
        }

        .meal-cell.leftovers {
            background-color: #f39c12;
            color: white;
            border: 2px solid #f39c12;
        }

        .meal-cell .meal-name {
            font-weight: bold;
            margin-bottom: 2px;
        }

        .meal-cell .meal-details {
            font-size: 0.7rem;
            opacity: 0.8;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #9b59b6;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        /* Buttons */
        .btn-primary {
            background-color: #9b59b6;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            width: 100%;
        }

        .btn-primary:hover {
            background-color: #8e44ad;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 0.8rem;
            border-radius: 4px;
            width: auto;
        }

        .btn-success {
            background-color: #27ae60;
            color: white;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #e74c3c;
        }

        /* Recipe Cards */
        .recipe-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.2s ease;
        }

        .recipe-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .recipe-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .recipe-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .difficulty-btn {
            padding: 8px 16px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .difficulty-btn.active {
            color: white;
        }

        .difficulty-btn.facile { border-color: #27ae60; }
        .difficulty-btn.medio { border-color: #f39c12; }
        .difficulty-btn.difficile { border-color: #e74c3c; }

        .difficulty-btn.facile.active { background-color: #27ae60; }
        .difficulty-btn.medio.active { background-color: #f39c12; }
        .difficulty-btn.difficile.active { background-color: #e74c3c; }

        .recipe-difficulty {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .recipe-difficulty.facile {
            background-color: #27ae60;
            color: white;
        }

        .recipe-difficulty.medio {
            background-color: #f39c12;
            color: white;
        }

        .recipe-difficulty.difficile {
            background-color: #e74c3c;
            color: white;
        }

        .recipe-meta {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        .recipe-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        /* Pantry */
        .pantry-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            background-color: #f8f9fa;
        }

        .pantry-item.negative {
            background-color: #ffebee;
            color: #c62828;
            border-left: 4px solid #e74c3c;
        }

        .pantry-item.low {
            background-color: #fff3e0;
            color: #f57c00;
            border-left: 4px solid #f39c12;
        }

        .pantry-quantity {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .ingredient-list {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .ingredient-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .ingredient-item input, .ingredient-item select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .ingredient-item .ingredient-name {
            flex: 2;
        }

        .ingredient-item .ingredient-quantity {
            flex: 1;
            max-width: 100px;
        }

        .ingredient-item .ingredient-unit {
            flex: 1;
            max-width: 80px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .title {
                font-size: 1.5rem;
            }
            
            .menu-table {
                font-size: 0.8rem;
            }
            
            .meal-label {
                width: 80px;
                font-size: 0.8rem;
                padding: 10px 4px;
            }
            
            .meal-cell {
                min-height: 50px;
                font-size: 0.75rem;
            }
            
            .nav-buttons {
                justify-content: center;
            }
            
            .nav-btn {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1 class="title">üçΩÔ∏è Menu & Kitchen Manager</h1>
            <div class="nav-buttons">
                <button class="nav-btn planning" onclick="showSection('planning')">üìÖ Planning Menu</button>
                <button class="nav-btn recipes" onclick="showSection('recipes')">üìñ Ricettario</button>
                <button class="nav-btn pantry" onclick="showSection('pantry')">ü•´ Dispensa</button>
                <button class="nav-btn frigo" onclick="showSection('frigo')">‚ùÑÔ∏è Frigo</button>
                <button class="nav-btn shopping" onclick="showSection('shopping')">üõí Lista Spesa</button>
                <button class="nav-btn" style="background-color: #2c3e50;" onclick="showSection('backup')">üíæ Backup</button>
                <!-- Backup & Restore -->
        <div id="backup-section" class="hidden-section">
            <div class="section">
                <h2>üíæ Backup & Restore</h2>
                <p style="margin-bottom: 20px; color: #7f8c8d;">
                    Salva tutti i tuoi dati (ricette, menu, dispensa, leftovers) in un file che puoi condividere o usare su altri dispositivi.
                </p>
                
                <div class="form-row">
                    <div class="form-group">
                        <h3>üì§ Esporta tutti i dati</h3>
                        <p>Scarica un file con tutte le tue ricette, menu pianificati, dispensa e leftovers.</p>
                        <button class="btn-primary btn-success" onclick="exportAllData()">üì§ Esporta Backup</button>
                    </div>
                    
                    <div class="form-group">
                        <h3>üì• Importa dati</h3>
                        <p>Carica un file di backup per ripristinare tutti i tuoi dati.</p>
                        <input type="file" id="import-file" accept=".json" style="margin-bottom: 10px;">
                        <button class="btn-primary" onclick="importAllData()">üì• Importa Backup</button>
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 20px;">
                    <h4>üìä Stato attuale dei dati:</h4>
                    <div id="data-stats">
                        <!-- Popolato dinamicamente -->
                    </div>
                </div>
                
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #ffc107;">
                    <h4>‚ö†Ô∏è Attenzione:</h4>
                    <p style="margin: 0;">L'importazione sostituir√† <strong>tutti</strong> i dati attuali. Assicurati di aver fatto un backup prima di importare nuovi dati!</p>
                </div>
            </div>
        </div>
    </div>
        </div>

        <!-- Planning Menu (default) -->
        <div id="planning-section">
            <div class="week-navigation">
                <button class="week-arrow" onclick="changeWeek(-1)">‚Äπ</button>
                <div class="week-info">
                    <div id="week-display">Settimana del 2 - 8 Giugno 2025</div>
                </div>
                <button class="week-arrow" onclick="changeWeek(1)">‚Ä∫</button>
            </div>

            <div class="section">
                <h2>üìÖ Planning Menu Settimanale</h2>
                <table class="menu-table">
                    <thead>
                        <tr>
                            <th style="width: 120px;">Giorno</th>
                            <th>BREAKFAST</th>
                            <th>SMOKO</th>
                            <th>LUNCH</th>
                            <th>DINNER</th>
                            <th>DESSERT</th>
                        </tr>
                    </thead>
                    <tbody id="menu-body">
                        <!-- Righe generate: ogni riga = un giorno, ogni colonna = un pasto -->
                        <tr>
                            <td class="meal-label">MON<br><small>9 GIU</small></td>
                            <td class="meal-cell empty" data-meal="breakfast" data-day="0" onclick="openMealModal('breakfast', 0)">+</td>
                            <td class="meal-cell empty" data-meal="smoko" data-day="0" onclick="openMealModal('smoko', 0)">+</td>
                            <td class="meal-cell empty" data-meal="lunch" data-day="0" onclick="openMealModal('lunch', 0)">+</td>
                            <td class="meal-cell empty" data-meal="dinner" data-day="0" onclick="openMealModal('dinner', 0)">+</td>
                            <td class="meal-cell empty" data-meal="dessert" data-day="0" onclick="openMealModal('dessert', 0)">+</td>
                        </tr>
                        <tr>
                            <td class="meal-label">TUE<br><small>10 GIU</small></td>
                            <td class="meal-cell empty" data-meal="breakfast" data-day="1" onclick="openMealModal('breakfast', 1)">+</td>
                            <td class="meal-cell empty" data-meal="smoko" data-day="1" onclick="openMealModal('smoko', 1)">+</td>
                            <td class="meal-cell empty" data-meal="lunch" data-day="1" onclick="openMealModal('lunch', 1)">+</td>
                            <td class="meal-cell empty" data-meal="dinner" data-day="1" onclick="openMealModal('dinner', 1)">+</td>
                            <td class="meal-cell empty" data-meal="dessert" data-day="1" onclick="openMealModal('dessert', 1)">+</td>
                        </tr>
                        <tr>
                            <td class="meal-label">WED<br><small>11 GIU</small></td>
                            <td class="meal-cell empty" data-meal="breakfast" data-day="2" onclick="openMealModal('breakfast', 2)">+</td>
                            <td class="meal-cell empty" data-meal="smoko" data-day="2" onclick="openMealModal('smoko', 2)">+</td>
                            <td class="meal-cell empty" data-meal="lunch" data-day="2" onclick="openMealModal('lunch', 2)">+</td>
                            <td class="meal-cell empty" data-meal="dinner" data-day="2" onclick="openMealModal('dinner', 2)">+</td>
                            <td class="meal-cell empty" data-meal="dessert" data-day="2" onclick="openMealModal('dessert', 2)">+</td>
                        </tr>
                        <tr>
                            <td class="meal-label">THU<br><small>12 GIU</small></td>
                            <td class="meal-cell empty" data-meal="breakfast" data-day="3" onclick="openMealModal('breakfast', 3)">+</td>
                            <td class="meal-cell empty" data-meal="smoko" data-day="3" onclick="openMealModal('smoko', 3)">+</td>
                            <td class="meal-cell empty" data-meal="lunch" data-day="3" onclick="openMealModal('lunch', 3)">+</td>
                            <td class="meal-cell empty" data-meal="dinner" data-day="3" onclick="openMealModal('dinner', 3)">+</td>
                            <td class="meal-cell empty" data-meal="dessert" data-day="3" onclick="openMealModal('dessert', 3)">+</td>
                        </tr>
                        <tr>
                            <td class="meal-label">FRI<br><small>13 GIU</small></td>
                            <td class="meal-cell empty" data-meal="breakfast" data-day="4" onclick="openMealModal('breakfast', 4)">+</td>
                            <td class="meal-cell empty" data-meal="smoko" data-day="4" onclick="openMealModal('smoko', 4)">+</td>
                            <td class="meal-cell empty" data-meal="lunch" data-day="4" onclick="openMealModal('lunch', 4)">+</td>
                            <td class="meal-cell empty" data-meal="dinner" data-day="4" onclick="openMealModal('dinner', 4)">+</td>
                            <td class="meal-cell empty" data-meal="dessert" data-day="4" onclick="openMealModal('dessert', 4)">+</td>
                        </tr>
                        <tr>
                            <td class="meal-label">SAT<br><small>14 GIU</small></td>
                            <td class="meal-cell empty" data-meal="breakfast" data-day="5" onclick="openMealModal('breakfast', 5)">+</td>
                            <td class="meal-cell empty" data-meal="smoko" data-day="5" onclick="openMealModal('smoko', 5)">+</td>
                            <td class="meal-cell empty" data-meal="lunch" data-day="5" onclick="openMealModal('lunch', 5)">+</td>
                            <td class="meal-cell empty" data-meal="dinner" data-day="5" onclick="openMealModal('dinner', 5)">+</td>
                            <td class="meal-cell empty" data-meal="dessert" data-day="5" onclick="openMealModal('dessert', 5)">+</td>
                        </tr>
                        <tr>
                            <td class="meal-label">SUN<br><small>15 GIU</small></td>
                            <td class="meal-cell empty" data-meal="breakfast" data-day="6" onclick="openMealModal('breakfast', 6)">+</td>
                            <td class="meal-cell empty" data-meal="smoko" data-day="6" onclick="openMealModal('smoko', 6)">+</td>
                            <td class="meal-cell empty" data-meal="lunch" data-day="6" onclick="openMealModal('lunch', 6)">+</td>
                            <td class="meal-cell empty" data-meal="dinner" data-day="6" onclick="openMealModal('dinner', 6)">+</td>
                            <td class="meal-cell empty" data-meal="dessert" data-day="6" onclick="openMealModal('dessert', 6)">+</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Ricettario -->
        <div id="recipes-section" class="hidden-section">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>üìñ Ricettario</h2>
                    <button class="btn-primary btn-small" onclick="openNewRecipeModal()">+ Nuova Ricetta</button>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Filtra per categoria:</label>
                        <select id="recipe-filter" onchange="filterRecipes()">
                            <option value="">Tutte le categorie</option>
                            <option value="colazione">üåÖ Colazione</option>
                            <option value="snack">‚òï Snack</option>
                            <option value="primo">üçù Primi</option>
                            <option value="secondo">ü•© Secondi</option>
                            <option value="contorno">ü•ó Contorni</option>
                            <option value="dolce">üç∞ Dolci</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Filtra per difficolt√†:</label>
                        <select id="difficulty-filter" onchange="filterRecipes()">
                            <option value="">Tutte le difficolt√†</option>
                            <option value="facile">Facile</option>
                            <option value="medio">Medio</option>
                            <option value="difficile">Difficile</option>
                        </select>
                    </div>
                </div>
                
                <div id="recipes-list">
                    <p>Nessuna ricetta ancora. Crea la tua prima ricetta!</p>
                </div>
            </div>
        </div>

        <!-- Dispensa -->
        <div id="pantry-section" class="hidden-section">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>ü•´ Dispensa</h2>
                    <button class="btn-primary btn-small" onclick="openAddIngredientModal()">+ Aggiungi Ingrediente</button>
                </div>
                
                <p style="margin-bottom: 20px; color: #7f8c8d;">
                    üî¥ Rosso = Mancante (da ordinare) | üü° Giallo = Scorte basse | ‚ö™ Normale = Disponibile
                </p>
                
                <div id="pantry-list">
                    <p>Dispensa vuota. Gli ingredienti appariranno quando pianifichi i menu o li aggiungi manualmente.</p>
                </div>
            </div>
        </div>

        <!-- Frigo -->
        <div id="frigo-section" class="hidden-section">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>‚ùÑÔ∏è Frigo & Leftovers</h2>
                    <button class="btn-primary btn-small" onclick="openAddLeftoverModal()">+ Aggiungi Leftovers</button>
                </div>
                
                <div id="leftovers-list">
                    <p>Frigo vuoto. I leftovers appariranno qui quando ne crei.</p>
                </div>
            </div>
        </div>

        <!-- Lista Spesa -->
        <div id="shopping-section" class="hidden-section">
            <div class="section">
                <h2>üõí Lista della Spesa</h2>
                <p style="margin-bottom: 20px; color: #7f8c8d;">
                    Lista generata automaticamente basata sugli ingredienti mancanti e sul menu pianificato.
                </p>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn-primary btn-small btn-success" onclick="generateShoppingList()">üîÑ Genera Lista</button>
                    <button class="btn-primary btn-small" onclick="exportShoppingList()" style="margin-left: 10px;">üìÑ Esporta PDF</button>
                </div>
                
                <div id="shopping-list">
                    <p>Clicca "Genera Lista" per creare la lista della spesa basata sui tuoi menu.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal per selezione pasto -->
    <div id="meal-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeMealModal()">&times;</span>
            <h2 id="meal-modal-title">Seleziona Pasto</h2>
            
            <div class="form-group">
                <label>Tipo:</label>
                <select id="meal-type" onchange="toggleMealType()">
                    <option value="recipe">Ricetta</option>
                    <option value="leftovers">Leftovers</option>
                </select>
            </div>
            
            <div id="recipe-selection">
                <div class="form-group">
                    <label>Seleziona Ricetta:</label>
                    <select id="meal-recipes">
                        <option value="">-- Seleziona --</option>
                    </select>
                </div>
            </div>
            
            <div id="leftovers-selection" style="display: none;">
                <div class="form-group">
                    <label>Seleziona Leftovers:</label>
                    <select id="meal-leftovers">
                        <option value="">-- Seleziona --</option>
                    </select>
                </div>
            </div>
            
            <button class="btn-primary" onclick="assignMeal()">Assegna</button>
        </div>
    </div>

    <!-- Modal per nuova ricetta -->
    <div id="recipe-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeRecipeModal()">&times;</span>
            <h2>üìñ Nuova Ricetta</h2>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Nome Ricetta:</label>
                    <input type="text" id="recipe-name" placeholder="es: Pasta al Pomodoro">
                </div>
                <div class="form-group">
                    <label>Categoria:</label>
                    <select id="recipe-category">
                        <option value="colazione">üåÖ Colazione</option>
                        <option value="snack">‚òï Snack</option>
                        <option value="primo">üçù Primi</option>
                        <option value="secondo">ü•© Secondi</option>
                        <option value="contorno">ü•ó Contorni</option>
                        <option value="dolce">üç∞ Dolci</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Tempo Preparazione (min):</label>
                    <input type="number" id="recipe-prep-time" value="15" min="1">
                </div>
                <div class="form-group">
                    <label>Tempo Cottura (min):</label>
                    <input type="number" id="recipe-cook-time" value="20" min="0">
                </div>
                <div class="form-group">
                    <label>Porzioni:</label>
                    <input type="number" id="recipe-portions" value="4" min="1">
                </div>
            </div>
            
            <div class="form-group">
                <label>Difficolt√†:</label>
                <div style="display: flex; gap: 10px;">
                    <button type="button" class="difficulty-btn facile active" onclick="setRecipeDifficulty('facile')">Facile</button>
                    <button type="button" class="difficulty-btn medio" onclick="setRecipeDifficulty('medio')">Medio</button>
                    <button type="button" class="difficulty-btn difficile" onclick="setRecipeDifficulty('difficile')">Difficile</button>
                </div>
                <input type="hidden" id="recipe-difficulty" value="facile">
            </div>
            
            <div class="form-group">
                <label>Ingredienti:</label>
                <div class="ingredient-list" id="ingredients-container">
                    <div class="ingredient-item">
                        <input type="text" class="ingredient-name" placeholder="Nome ingrediente">
                        <input type="number" class="ingredient-quantity" placeholder="Qt√†" step="0.1" min="0">
                        <select class="ingredient-unit">
                            <option value="g">g</option>
                            <option value="kg">kg</option>
                            <option value="ml">ml</option>
                            <option value="l">l</option>
                            <option value="pz">pz</option>
                            <option value="pizzico">pizzico</option>
                        </select>
                        <button type="button" onclick="removeIngredient(this)" class="btn-small btn-danger">‚úï</button>
                    </div>
                </div>
                <button type="button" onclick="addIngredient()" class="btn-small btn-success" style="margin-top: 10px;">+ Ingrediente</button>
            </div>
            
            <div class="form-group">
                <label>Procedimento:</label>
                <textarea id="recipe-procedure" rows="5" placeholder="Descrivi i passaggi per preparare la ricetta..."></textarea>
            </div>
            
            <div class="form-group">
                <label>Note (opzionale):</label>
                <textarea id="recipe-notes" rows="2" placeholder="Consigli, varianti, conservazione..."></textarea>
            </div>
            
            <button class="btn-primary" onclick="saveRecipe()">Salva Ricetta</button>
        </div>
    </div>

    <!-- Modal per aggiungere ingrediente -->
    <div id="ingredient-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeIngredientModal()">&times;</span>
            <h2>ü•´ Aggiungi Ingrediente</h2>
            
            <div class="form-group">
                <label>Nome Ingrediente:</label>
                <input type="text" id="ingredient-name" placeholder="es: Pomodori">
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Quantit√†:</label>
                    <input type="number" id="ingredient-quantity" placeholder="es: 500" step="0.1">
                </div>
                <div class="form-group">
                    <label>Unit√†:</label>
                    <select id="ingredient-unit">
                        <option value="g">g</option>
                        <option value="kg">kg</option>
                        <option value="ml">ml</option>
                        <option value="l">l</option>
                        <option value="pz">pz</option>
                    </select>
                </div>
            </div>
            
            <button class="btn-primary" onclick="addIngredientToPantry()">Aggiungi alla Dispensa</button>
        </div>
    </div>

    <!-- Modal per leftovers -->
    <div id="leftover-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeLeftoverModal()">&times;</span>
            <h2>‚ùÑÔ∏è Aggiungi Leftovers</h2>
            
            <div class="form-group">
                <label>Nome:</label>
                <input type="text" id="leftover-name" placeholder="es: Pasta al Pomodoro (avanzata)">
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Porzioni rimaste:</label>
                    <input type="number" id="leftover-portions" value="2" min="1">
                </div>
                <div class="form-group">
                    <label>Data preparazione:</label>
                    <input type="date" id="leftover-date">
                </div>
            </div>
            
            <button class="btn-primary" onclick="addLeftover()">Aggiungi al Frigo</button>
        </div>
    </div>

    <script>
        // Dati globali
        let recipes = [];
        let menuPlanning = {};
        let pantry = {};
        let leftovers = [];
        let currentWeekOffset = 0;

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            updateWeekDisplay();
            updateMenuCells(); // Solo aggiorna le celle, non rigenera la tabella
            setTodayDate();
        });

        function loadData() {
            try {
                recipes = JSON.parse(localStorage.getItem('recipes') || '[]');
                menuPlanning = JSON.parse(localStorage.getItem('menuPlanning') || '{}');
                pantry = JSON.parse(localStorage.getItem('pantry') || '{}');
                leftovers = JSON.parse(localStorage.getItem('leftovers') || '[]');
            } catch (e) {
                console.error('Errore nel caricamento dati:', e);
                recipes = [];
                menuPlanning = {};
                pantry = {};
                leftovers = [];
            }
        }

        function saveData() {
            try {
                localStorage.setItem('recipes', JSON.stringify(recipes));
                localStorage.setItem('menuPlanning', JSON.stringify(menuPlanning));
                localStorage.setItem('pantry', JSON.stringify(pantry));
                localStorage.setItem('leftovers', JSON.stringify(leftovers));
            } catch (e) {
                console.error('Errore nel salvataggio dati:', e);
            }
        }

        function showSection(sectionName) {
            document.getElementById('planning-section').style.display = 'none';
            document.querySelectorAll('.hidden-section').forEach(section => {
                section.style.display = 'none';
            });

            if (sectionName === 'planning') {
                document.getElementById('planning-section').style.display = 'block';
                updateMenuCells(); // Aggiorna solo le celle quando mostra la sezione
            } else {
                const section = document.getElementById(sectionName + '-section');
                if (section) {
                    section.style.display = 'block';
                    if (sectionName === 'recipes') displayRecipes();
                    if (sectionName === 'pantry') displayPantry();
                    if (sectionName === 'frigo') displayLeftovers();
                    if (sectionName === 'backup') displayDataStats();
                }
            }
        }

        function generateMenuTable() {
            // La tabella √® ora statica nell'HTML, ma dobbiamo aggiornare il contenuto delle celle
            updateMenuCells();
        }

        function updateMenuCells() {
            const cells = document.querySelectorAll('.meal-cell');
            
            cells.forEach(cell => {
                const meal = cell.dataset.meal;
                const day = parseInt(cell.dataset.day);
                
                const weekKey = getWeekKey();
                const mealKey = `${weekKey}-${day}-${meal}`;
                
                // Reset della cella
                cell.className = 'meal-cell empty';
                cell.textContent = '+';
                
                const entries = Array.isArray(menuPlanning[mealKey])
                    ? menuPlanning[mealKey]
                    : (menuPlanning[mealKey] ? [menuPlanning[mealKey]] : []);

                if (entries.length) {
                    cell.classList.remove('empty');
                    cell.classList.add('filled');

                    // evidenzia se almeno una voce √® leftovers
                    if (entries.some(e => e.type === 'leftovers')) {
                        cell.classList.add('leftovers');
                    }

                    // mostra ogni voce su una riga
                    cell.innerHTML = entries
                        .map((e, index) => `
                            <div class="meal-item" style="display: flex; align-items: center; margin: 2px 0;">
                                <div class="meal-name" 
                                    onclick="viewMealDetails('${meal}', ${day}, ${index})" 
                                    style="cursor: pointer; flex-grow: 1; transition: all 0.2s;"
                                    onmouseover="this.style.textDecoration='underline'"
                                    onmouseout="this.style.textDecoration='none'"
                                    onclick="event.stopPropagation(); viewMealDetails('${meal}', ${day}, ${index})"
                                >${e.name}</div>
                            </div>
                        `)
                        .join('');

                    // tooltip con tutti i nomi
                    cell.title = entries.map(e => e.name).join(' | ');
                }

                // Aggiungi il gestore del click
                cell.onclick = () => openMealModal(meal, day);
            });
        }

        function getWeekKey() {
            const today = new Date();
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay() + (currentWeekOffset * 7));
            return weekStart.toISOString().split('T')[0];
        }

        function changeWeek(direction) {
            currentWeekOffset += direction;
            updateWeekDisplay();
            updateMenuCells(); // Aggiorna le celle invece di rigenerare la tabella
        }

        function updateWeekDisplay() {
            const today = new Date();
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay() + (currentWeekOffset * 7));
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            
            const options = { day: 'numeric', month: 'short' };
            const startStr = weekStart.toLocaleDateString('it-IT', options);
            const endStr = weekEnd.toLocaleDateString('it-IT', options);
            
            const weekDisplay = document.getElementById('week-display');
            if (weekDisplay) {
                weekDisplay.textContent = `Settimana del ${startStr} - ${endStr} ${weekStart.getFullYear()}`;
            }
        }

        // Recipe Functions
        function openNewRecipeModal() {
            document.getElementById('recipe-modal').style.display = 'block';
        }

        function closeRecipeModal() {
            document.getElementById('recipe-modal').style.display = 'none';
            resetRecipeForm();
        }

        function resetRecipeForm() {
            document.getElementById('recipe-name').value = '';
            document.getElementById('recipe-prep-time').value = '15';
            document.getElementById('recipe-cook-time').value = '20';
            document.getElementById('recipe-portions').value = '4';
            document.getElementById('recipe-procedure').value = '';
            document.getElementById('recipe-notes').value = '';
            setRecipeDifficulty('facile');
            
            const container = document.getElementById('ingredients-container');
            container.innerHTML = `
                <div class="ingredient-item">
                    <input type="text" class="ingredient-name" placeholder="Nome ingrediente">
                    <input type="number" class="ingredient-quantity" placeholder="Qt√†" step="0.1" min="0">
                    <select class="ingredient-unit">
                        <option value="g">g</option>
                        <option value="kg">kg</option>
                        <option value="ml">ml</option>
                        <option value="l">l</option>
                        <option value="pz">pz</option>
                        <option value="pizzico">pizzico</option>
                    </select>
                    <button type="button" onclick="removeIngredient(this)" class="btn-small btn-danger">‚úï</button>
                </div>
            `;
        }

        function setRecipeDifficulty(difficulty) {
            document.querySelectorAll('.difficulty-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.difficulty-btn.${difficulty}`).classList.add('active');
            document.getElementById('recipe-difficulty').value = difficulty;
        }

        function addIngredient() {
            const container = document.getElementById('ingredients-container');
            const newIngredient = document.createElement('div');
            newIngredient.className = 'ingredient-item';
            newIngredient.innerHTML = `
                <input type="text" class="ingredient-name" placeholder="Nome ingrediente">
                <input type="number" class="ingredient-quantity" placeholder="Qt√†" step="0.1" min="0">
                <select class="ingredient-unit">
                    <option value="g">g</option>
                    <option value="kg">kg</option>
                    <option value="ml">ml</option>
                    <option value="l">l</option>
                    <option value="pz">pz</option>
                    <option value="pizzico">pizzico</option>
                </select>
                <button type="button" onclick="removeIngredient(this)" class="btn-small btn-danger">‚úï</button>
            `;
            container.appendChild(newIngredient);
        }

        function removeIngredient(button) {
            button.parentElement.remove();
        }

        function saveRecipe() {
            const name = document.getElementById('recipe-name').value.trim();
            if (!name) {
                alert('Inserisci il nome della ricetta');
                return;
            }

            const ingredients = [];
            document.querySelectorAll('.ingredient-item').forEach(item => {
                const ingredientName = item.querySelector('.ingredient-name').value.trim();
                const quantity = parseFloat(item.querySelector('.ingredient-quantity').value);
                const unit = item.querySelector('.ingredient-unit').value;
                
                if (ingredientName && quantity > 0) {
                    ingredients.push({
                        name: ingredientName,
                        quantity: quantity,
                        unit: unit
                    });
                }
            });

            const recipe = {
                id: Date.now(),
                name: name,
                category: document.getElementById('recipe-category').value,
                prepTime: parseInt(document.getElementById('recipe-prep-time').value),
                cookTime: parseInt(document.getElementById('recipe-cook-time').value),
                portions: parseInt(document.getElementById('recipe-portions').value),
                difficulty: document.getElementById('recipe-difficulty').value,
                ingredients: ingredients,
                procedure: document.getElementById('recipe-procedure').value.trim(),
                notes: document.getElementById('recipe-notes').value.trim(),
                createdAt: new Date().toISOString()
            };

            recipes.push(recipe);
            saveData();
            updateRecipeSelects();
            closeRecipeModal();
            alert('Ricetta salvata!');
        }

        function updateRecipeSelects() {
            const mealRecipesSelect = document.getElementById('meal-recipes');
            if (mealRecipesSelect) {
                mealRecipesSelect.innerHTML = '<option value="">-- Seleziona --</option>';
                recipes.forEach(recipe => {
                    const option = document.createElement('option');
                    option.value = recipe.id;
                    option.textContent = `${recipe.name} (${recipe.portions} porzioni)`;
                    mealRecipesSelect.appendChild(option);
                });
            }
        }

        function filterRecipes() {
            displayRecipes();
        }

        function displayRecipes() {
            const container = document.getElementById('recipes-list');
            const categoryFilter = document.getElementById('recipe-filter').value;
            const difficultyFilter = document.getElementById('difficulty-filter').value;
            
            let filteredRecipes = recipes;
            
            if (categoryFilter) {
                filteredRecipes = filteredRecipes.filter(recipe => recipe.category === categoryFilter);
            }
            
            if (difficultyFilter) {
                filteredRecipes = filteredRecipes.filter(recipe => recipe.difficulty === difficultyFilter);
            }
            
            if (filteredRecipes.length === 0) {
                container.innerHTML = '<p>Nessuna ricetta trovata. Crea la tua prima ricetta!</p>';
                return;
            }
            
            container.innerHTML = filteredRecipes.map(recipe => {
                return `
                    <div class="recipe-card">
                        <div class="recipe-header">
                            <span class="recipe-title">${recipe.name}</span>
                            <span class="recipe-difficulty ${recipe.difficulty}">${recipe.difficulty}</span>
                        </div>
                        <div class="recipe-meta">
                            <span>‚è±Ô∏è Prep: ${recipe.prepTime}min</span>
                            <span>üî• Cottura: ${recipe.cookTime}min</span>
                            <span>üçΩÔ∏è ${recipe.portions} porzioni</span>
                        </div>
                        <p style="margin: 10px 0; font-size: 0.9rem; color: #666;">
                            ${recipe.procedure.substring(0, 150)}${recipe.procedure.length > 150 ? '...' : ''}
                        </p>
                        <div class="recipe-actions">
                            <button onclick="viewRecipe(${recipe.id})" class="btn-small" style="background: #3498db; color: white;">üëÅÔ∏è Visualizza</button>
                            <button onclick="deleteRecipe(${recipe.id})" class="btn-small btn-danger">üóëÔ∏è Elimina</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function viewRecipe(recipeId) {
            const recipe = recipes.find(r => r.id === recipeId);
            if (!recipe) return;
            
            const ingredientsList = recipe.ingredients.map(ing => `‚Ä¢ ${ing.quantity} ${ing.unit} ${ing.name}`).join('\n');
            
            alert(`üìñ ${recipe.name}\n\nüçΩÔ∏è Porzioni: ${recipe.portions}\n‚è±Ô∏è Tempo totale: ${recipe.prepTime + recipe.cookTime} min\nüåü Difficolt√†: ${recipe.difficulty}\n\nüìù Ingredienti:\n${ingredientsList}\n\nüë®‚Äçüç≥ Procedimento:\n${recipe.procedure}\n\n${recipe.notes ? 'üìå Note:\n' + recipe.notes : ''}`);
        }

        function deleteRecipe(recipeId) {
            if (confirm('Sei sicuro di voler eliminare questa ricetta?')) {
                recipes = recipes.filter(r => r.id !== recipeId);
                saveData();
                displayRecipes();
                updateRecipeSelects();
            }
        }

        // Meal Assignment
        function openMealModal(meal, day) {
            const dayNames = ['Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨', 'Sabato', 'Domenica'];
            const mealNames = {
                'breakfast': 'BREAKFAST',
                'smoko': 'SMOKO', 
                'lunch': 'LUNCH',
                'dinner': 'DINNER',
                'dessert': 'DESSERT'
            };
            
            document.getElementById('meal-modal-title').textContent = `${mealNames[meal]} - ${dayNames[day]}`;
            document.getElementById('meal-modal').dataset.meal = meal;
            document.getElementById('meal-modal').dataset.day = day;
            document.getElementById('meal-modal').style.display = 'block';
            
            document.getElementById('meal-type').value = 'recipe';
            toggleMealType();
            updateRecipeSelects();
            updateLeftoversSelect();
        }

        function closeMealModal() {
            document.getElementById('meal-modal').style.display = 'none';
        }

        function toggleMealType() {
            const type = document.getElementById('meal-type').value;
            const recipeSection = document.getElementById('recipe-selection');
            const leftoversSection = document.getElementById('leftovers-selection');
            
            if (type === 'recipe') {
                recipeSection.style.display = 'block';
                leftoversSection.style.display = 'none';
            } else {
                recipeSection.style.display = 'none';
                leftoversSection.style.display = 'block';
            }
        }

        function assignMeal() {
            const meal = document.getElementById('meal-modal').dataset.meal;
            const day = parseInt(document.getElementById('meal-modal').dataset.day);
            const type = document.getElementById('meal-type').value;
            
            let mealData = {};
            
            if (type === 'recipe') {
                const recipeId = document.getElementById('meal-recipes').value;
                if (!recipeId) {
                    alert('Seleziona una ricetta');
                    return;
                }
                const recipe = recipes.find(r => r.id === parseInt(recipeId));
                mealData = {
                    type: 'recipe',
                    recipeId: parseInt(recipeId),
                    name: recipe.name
                };
                
                updatePantryFromRecipe(recipe);
                
            } else {
                const leftoverId = document.getElementById('meal-leftovers').value;
                if (!leftoverId) {
                    alert('Seleziona dei leftovers');
                    return;
                }
                const leftover = leftovers.find(l => l.id === parseInt(leftoverId));
                mealData = {
                    type: 'leftovers',
                    leftoverId: parseInt(leftoverId),
                    name: leftover.name
                };
            }
            
            const weekKey = getWeekKey();
            const mealKey = `${weekKey}-${day}-${meal}`;

            // ‚ñ∫ Permetti pi√π voci nella stessa casella
            if (!Array.isArray(menuPlanning[mealKey])) {
                menuPlanning[mealKey] = [];          // crea l‚Äôarray se non esiste
            }
            menuPlanning[mealKey].push(mealData);    // aggiunge la voce
            
            saveData();
            closeMealModal();
            updateMenuCells(); // Aggiorna le celle invece di rigenerare
        }

        function updatePantryFromRecipe(recipe) {
            recipe.ingredients.forEach(ingredient => {
                const ingredientKey = ingredient.name.toLowerCase();
                if (!pantry[ingredientKey]) {
                    pantry[ingredientKey] = {
                        name: ingredient.name,
                        quantity: 0,
                        unit: ingredient.unit,
                        threshold: getDefaultThreshold(ingredient.unit)
                    };
                }
                
                pantry[ingredientKey].quantity -= ingredient.quantity;
            });
        }

        function getDefaultThreshold(unit) {
            const thresholds = {
                'g': 100,
                'kg': 0.5,
                'ml': 100,
                'l': 0.2,
                'pz': 2
            };
            return thresholds[unit] || 1;
        }

        function removeMealItem(meal, day, index) {
            const weekKey = getWeekKey();
            const mealKey = `${weekKey}-${day}-${meal}`;
            
            // Rimuovi la voce specifica dall'array
            if (Array.isArray(menuPlanning[mealKey])) {
                menuPlanning[mealKey].splice(index, 1);
                
                // Se non ci sono pi√π voci, rimuovi la chiave
                if (menuPlanning[mealKey].length === 0) {
                    delete menuPlanning[mealKey];
                }
                
                saveData();
                updateMenuCells();
            }
        }

        function viewMealDetails(meal, day, index) {
            const weekKey = getWeekKey();
            const mealKey = `${weekKey}-${day}-${meal}`;
            
            if (!Array.isArray(menuPlanning[mealKey]) || !menuPlanning[mealKey][index]) {
                return;
            }

            const mealItem = menuPlanning[mealKey][index];
            
            if (mealItem.type === 'recipe') {
                const recipe = recipes.find(r => r.id === mealItem.recipeId);
                if (recipe) {
                    const ingredientsList = recipe.ingredients.map(ing => `‚Ä¢ ${ing.quantity} ${ing.unit} ${ing.name}`).join('\n');
                    if (confirm(`üìñ ${recipe.name}\n\nüçΩÔ∏è Porzioni: ${recipe.portions}\n‚è±Ô∏è Tempo totale: ${recipe.prepTime + recipe.cookTime} min\nüåü Difficolt√†: ${recipe.difficulty}\n\nüìù Ingredienti:\n${ingredientsList}\n\nüë®‚Äçüç≥ Procedimento:\n${recipe.procedure}\n\n${recipe.notes ? 'üìå Note:\n' + recipe.notes : ''}\n\n‚ùå Vuoi rimuovere questa ricetta dal menu?`)) {
                        removeMealItem(meal, day, index);
                    }
                }
            } else if (mealItem.type === 'leftovers') {
                const leftover = leftovers.find(l => l.id === mealItem.leftoverId);
                if (leftover) {
                    if (confirm(`üç± Leftovers: ${leftover.name}\nüìÖ Data: ${new Date(leftover.date).toLocaleDateString('it-IT')}\nüçΩÔ∏è Porzioni: ${leftover.portions}\n\n‚ùå Vuoi rimuovere questo leftover dal menu?`)) {
                        removeMealItem(meal, day, index);
                    }
                }
            }
        }

        // Pantry Functions
        function openAddIngredientModal() {
            document.getElementById('ingredient-modal').style.display = 'block';
        }

        function closeIngredientModal() {
            document.getElementById('ingredient-modal').style.display = 'none';
            document.getElementById('ingredient-name').value = '';
            document.getElementById('ingredient-quantity').value = '';
        }

        function addIngredientToPantry() {
            const name = document.getElementById('ingredient-name').value.trim();
            const quantity = parseFloat(document.getElementById('ingredient-quantity').value);
            const unit = document.getElementById('ingredient-unit').value;
            
            if (!name || isNaN(quantity)) {
                alert('Inserisci nome e quantit√† validi');
                return;
            }
            
            const ingredientKey = name.toLowerCase();
            
            if (pantry[ingredientKey]) {
                pantry[ingredientKey].quantity += quantity;
            } else {
                pantry[ingredientKey] = {
                    name: name,
                    quantity: quantity,
                    unit: unit,
                    threshold: getDefaultThreshold(unit)
                };
            }
            
            saveData();
            closeIngredientModal();
            alert('Ingrediente aggiunto alla dispensa!');
        }

        function displayPantry() {
            const container = document.getElementById('pantry-list');
            
            if (Object.keys(pantry).length === 0) {
                container.innerHTML = '<p>Dispensa vuota. Gli ingredienti appariranno quando pianifichi i menu o li aggiungi manualmente.</p>';
                return;
            }
            
            const sortedIngredients = Object.entries(pantry).sort((a, b) => {
                const statusA = getIngredientStatus(a[1]);
                const statusB = getIngredientStatus(b[1]);
                if (statusA !== statusB) {
                    return statusA === 'negative' ? -1 : (statusB === 'negative' ? 1 : (statusA === 'low' ? -1 : 1));
                }
                return a[1].name.localeCompare(b[1].name);
            });
            
            container.innerHTML = sortedIngredients.map(([key, ingredient]) => {
                const status = getIngredientStatus(ingredient);
                return `
                    <div class="pantry-item ${status}">
                        <div>
                            <span style="font-weight: 600;">${ingredient.name}</span>
                        </div>
                        <span class="pantry-quantity">${ingredient.quantity > 0 ? '+' : ''}${ingredient.quantity} ${ingredient.unit}</span>
                    </div>
                `;
            }).join('');
        }

        function getIngredientStatus(ingredient) {
            if (ingredient.quantity < 0) return 'negative';
            if (ingredient.quantity <= ingredient.threshold) return 'low';
            return 'normal';
        }

        // Leftovers Functions
        function openAddLeftoverModal() {
            document.getElementById('leftover-modal').style.display = 'block';
        }

        function closeLeftoverModal() {
            document.getElementById('leftover-modal').style.display = 'none';
            document.getElementById('leftover-name').value = '';
            document.getElementById('leftover-portions').value = '2';
        }

        function addLeftover() {
            const name = document.getElementById('leftover-name').value.trim();
            const portions = parseInt(document.getElementById('leftover-portions').value);
            const date = document.getElementById('leftover-date').value;
            
            if (!name || !portions || !date) {
                alert('Inserisci nome, porzioni e data');
                return;
            }
            
            const leftover = {
                id: Date.now(),
                name: name,
                portions: portions,
                date: date,
                createdAt: new Date().toISOString()
            };
            
            leftovers.push(leftover);
            saveData();
            closeLeftoverModal();
            alert('Leftovers aggiunti al frigo!');
        }

        function displayLeftovers() {
            const container = document.getElementById('leftovers-list');
            
            if (leftovers.length === 0) {
                container.innerHTML = '<p>Frigo vuoto. I leftovers appariranno qui quando ne crei.</p>';
                return;
            }
            
            container.innerHTML = leftovers.map(leftover => {
                const daysSince = Math.floor((new Date() - new Date(leftover.date)) / (1000 * 60 * 60 * 24));
                const freshnessColor = daysSince <= 1 ? '#27ae60' : (daysSince <= 3 ? '#f39c12' : '#e74c3c');
                
                return `
                    <div class="recipe-card">
                        <div class="recipe-header">
                            <span class="recipe-title">${leftover.name}</span>
                            <span style="background: ${freshnessColor}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem;">
                                ${daysSince === 0 ? 'Oggi' : `${daysSince} giorni fa`}
                            </span>
                        </div>
                        <div class="recipe-meta">
                            <span>üçΩÔ∏è ${leftover.portions} porzioni</span>
                            <span>üìÖ ${new Date(leftover.date).toLocaleDateString('it-IT')}</span>
                        </div>
                        <div class="recipe-actions">
                            <button onclick="deleteLeftover(${leftover.id})" class="btn-small btn-danger">üóëÔ∏è Consumato</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function deleteLeftover(leftoverId) {
            if (confirm('Hai consumato questi leftovers?')) {
                leftovers = leftovers.filter(l => l.id !== leftoverId);
                saveData();
                displayLeftovers();
                updateLeftoversSelect();
            }
        }

        function updateLeftoversSelect() {
            const select = document.getElementById('meal-leftovers');
            if (!select) return;
            
            select.innerHTML = '<option value="">-- Seleziona --</option>';
            leftovers.forEach(leftover => {
                const option = document.createElement('option');
                option.value = leftover.id;
                option.textContent = `${leftover.name} (${leftover.portions} porzioni)`;
                select.appendChild(option);
            });
        }

        // Shopping List
        function generateShoppingList() {
            const container = document.getElementById('shopping-list');
            
            const needToBuy = Object.entries(pantry).filter(([key, ingredient]) => {
                return ingredient.quantity < 0 || ingredient.quantity <= ingredient.threshold;
            });
            
            if (needToBuy.length === 0) {
                container.innerHTML = '<p style="color: #27ae60; font-weight: 600;">‚úÖ Nessun ingrediente da acquistare!</p>';
                return;
            }
            
            const missing = needToBuy.filter(([key, ingredient]) => ingredient.quantity < 0);
            const lowStock = needToBuy.filter(([key, ingredient]) => ingredient.quantity >= 0 && ingredient.quantity <= ingredient.threshold);
            
            let html = '<div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">';
            
            if (missing.length > 0) {
                html += '<h4 style="color: #e74c3c; margin-bottom: 15px;">üî¥ MANCANTI</h4>';
                missing.forEach(([key, ingredient]) => {
                    const needed = Math.abs(ingredient.quantity);
                    html += `
                        <div class="pantry-item negative">
                            <span>${ingredient.name}</span>
                            <span class="pantry-quantity">${needed} ${ingredient.unit}</span>
                        </div>
                    `;
                });
            }
            
            if (lowStock.length > 0) {
                html += '<h4 style="color: #f39c12; margin: 20px 0 15px 0;">üü° SCORTE BASSE</h4>';
                lowStock.forEach(([key, ingredient]) => {
                    const suggested = ingredient.threshold * 2;
                    html += `
                        <div class="pantry-item low">
                            <span>${ingredient.name}</span>
                            <span class="pantry-quantity">${suggested} ${ingredient.unit}</span>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        function exportShoppingList() {
            const needToBuy = Object.entries(pantry).filter(([key, ingredient]) => {
                return ingredient.quantity < 0 || ingredient.quantity <= ingredient.threshold;
            });
            
            if (needToBuy.length === 0) {
                alert('Nessun ingrediente da acquistare!');
                return;
            }
            
            let content = `LISTA DELLA SPESA\nGenerata il ${new Date().toLocaleDateString('it-IT')}\n\n`;
            
            needToBuy.forEach(([key, ingredient]) => {
                const needed = ingredient.quantity < 0 ? Math.abs(ingredient.quantity) : ingredient.threshold * 2;
                content += `‚òê ${ingredient.name}: ${needed} ${ingredient.unit}\n`;
            });
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Lista_Spesa_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('Lista della spesa esportata!');
        }

        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('leftover-date');
            if (dateInput) {
                dateInput.value = today;
            }
        }

        // Backup & Restore Functions
        function exportAllData() {
            const allData = {
                recipes: recipes,
                menuPlanning: menuPlanning,
                pantry: pantry,
                leftovers: leftovers,
                exportDate: new Date().toISOString(),
                appVersion: "1.0"
            };
            
            const dataString = JSON.stringify(allData, null, 2);
            const blob = new Blob([dataString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `Kitchen_Manager_Backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Backup esportato con successo! Il file contiene tutte le tue ricette, menu, dispensa e leftovers.');
        }

        function importAllData() {
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Seleziona un file di backup da importare');
                return;
            }
            
            if (!file.name.endsWith('.json')) {
                alert('Il file deve essere in formato JSON');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Verifica che il file abbia la struttura corretta
                    if (!importedData.recipes || !Array.isArray(importedData.recipes)) {
                        throw new Error('File di backup non valido');
                    }
                    
                    // Conferma prima di sovrascrivere
                    const currentTotal = recipes.length + Object.keys(menuPlanning).length + Object.keys(pantry).length + leftovers.length;
                    const importTotal = importedData.recipes.length + Object.keys(importedData.menuPlanning || {}).length + Object.keys(importedData.pantry || {}).length + (importedData.leftovers || []).length;
                    
                    const confirmMessage = `‚ö†Ô∏è ATTENZIONE: Questo sostituir√† tutti i dati attuali!\n\nDati attuali: ${currentTotal} elementi\nDati da importare: ${importTotal} elementi\n\nContinuare?`;
                    
                    if (!confirm(confirmMessage)) {
                        return;
                    }
                    
                    // Importa i dati
                    recipes = importedData.recipes || [];
                    menuPlanning = importedData.menuPlanning || {};
                    pantry = importedData.pantry || {};
                    leftovers = importedData.leftovers || [];
                    
                    // Salva nel localStorage
                    saveData();
                    
                    // Aggiorna tutte le interfacce
                    updateRecipeSelects();
                    updateLeftoversSelect();
                    updateMenuCells();
                    displayDataStats();
                    
                    alert(`‚úÖ Backup importato con successo!\n\nüìñ ${recipes.length} ricette\nüìÖ ${Object.keys(menuPlanning).length} pasti pianificati\nü•´ ${Object.keys(pantry).length} ingredienti in dispensa\n‚ùÑÔ∏è ${leftovers.length} leftovers`);
                    
                    // Reset del file input
                    fileInput.value = '';
                    
                } catch (error) {
                    console.error('Errore importazione:', error);
                    alert('‚ùå Errore nell\'importazione del file. Assicurati che sia un backup valido del Kitchen Manager.');
                }
            };
            
            reader.readAsText(file);
        }

        function displayDataStats() {
            const container = document.getElementById('data-stats');
            if (!container) return;
            
            const recipesCount = recipes.length;
            const menuCount = Object.keys(menuPlanning).length;
            const pantryCount = Object.keys(pantry).length;
            const leftoversCount = leftovers.length;
            const totalItems = recipesCount + menuCount + pantryCount + leftoversCount;
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2rem; color: #e74c3c;">üìñ</div>
                        <div style="font-weight: 600; margin-top: 5px;">${recipesCount} Ricette</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2rem; color: #9b59b6;">üìÖ</div>
                        <div style="font-weight: 600; margin-top: 5px;">${menuCount} Pasti Pianificati</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2rem; color: #27ae60;">ü•´</div>
                        <div style="font-weight: 600; margin-top: 5px;">${pantryCount} Ingredienti</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2rem; color: #3498db;">‚ùÑÔ∏è</div>
                        <div style="font-weight: 600; margin-top: 5px;">${leftoversCount} Leftovers</div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 15px; font-weight: 600; color: #2c3e50;">
                    Totale: ${totalItems} elementi salvati
                </div>
            `;
        }

        // Event Listeners
        window.onclick = function(event) {
            const modals = ['meal-modal', 'recipe-modal', 'ingredient-modal', 'leftover-modal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Inizializza
        showSection('planning');
    </script>
</body>
</html>